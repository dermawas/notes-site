<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>FlowformLab CMS</title>
    <meta name="robots" content="noindex" />

    <!-- Tell Decap not to auto-start; we'll start it after we fix/record auth. -->
    <script>window.CMS_MANUAL_INIT = true;</script>

    <script>
      (function () {
        var OAUTH_ORIGIN = "https://ffl-oauth.vercel.app";

        function saveUser(user) {
          try {
            var normalized = { token: user && user.token, provider: "github" };
            if (!normalized.token) return;
            localStorage.setItem("decap-cms-user", JSON.stringify(normalized));
            localStorage.setItem("netlify-cms-user", JSON.stringify(normalized));
          } catch (e) {
            console.error("[admin] failed to write cms-user:", e);
          }
        }

        // Upgrade any existing value (add provider, mirror legacy key)
        (function upgradeExisting() {
          try {
            var raw = localStorage.getItem("decap-cms-user");
            if (!raw) return;
            var obj = {};
            try { obj = JSON.parse(raw); } catch (_) {}
            if (obj && obj.token) {
              if (!obj.provider) obj.provider = "github";
              saveUser(obj);
              console.log("[admin] normalized existing decap-cms-user");
            }
          } catch (e) {
            console.warn("[admin] upgradeExisting error:", e);
          }
        })();

        // Listen for OAuth popup success/error
        window.addEventListener("message", function (e) {
          if (e.origin !== OAUTH_ORIGIN || typeof e.data !== "string") return;

          if (e.data.indexOf("authorization:github:success:") === 0) {
            var token = e.data.replace("authorization:github:success:", "").trim();
            saveUser({ token: token });

            // Bust cached bundle once after auth so CMS sees the new user
            var url = location.pathname + "?no_bundle_cache=1" + location.hash;
            location.replace(url);
          }
          if (e.data.indexOf("authorization:github:error:") === 0) {
            console.error("[admin] OAuth error:", e.data);
          }
        }, false);

        // Start CMS after our shim has run and the CMS script is present
        function startCMSWhenReady() {
          if (window.CMS && CMS.init) {
            try { CMS.init(); } catch (e) { console.error("[admin] CMS.init error:", e); }
          } else {
            setTimeout(startCMSWhenReady, 50);
          }
        }
        // Kick off the poller; the CMS script tag is below.
        startCMSWhenReady();
      })();
    </script>
  </head>
  <body>
    <!-- Decap CMS -->
    <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
  </body>
</html>
