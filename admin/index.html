<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>FlowformLab CMS</title>
    <meta name="robots" content="noindex" />

    <script>
      /* ------------------------------------------------------------
         FlowformLab Admin bootstrap (Decap CMS, GitHub OAuth)
         - Manual init so we can guard with username allowlist
         - Single-flight guard to prevent double CMS.init()
         ------------------------------------------------------------ */

      // Allowlist: only these GitHub usernames can use the CMS
      const ALLOWED_USERS = ["dermawas"]; // add more as needed

      // Manual init so we can enforce allowlist first
      window.CMS_MANUAL_INIT = true;

      // Single-flight guard (avoid double mounts)
      window.__CMS_BOOT = { initialized: false, initializing: false };

      function scheduleInitOnce() {
        if (window.__CMS_BOOT.initialized || window.__CMS_BOOT.initializing) return;
        window.__CMS_BOOT.initializing = true;

        // Wait until CMS bundle is actually ready, then init exactly once
        (function tryInit() {
          if (window.CMS && typeof CMS.init === "function") {
            if (!window.__CMS_BOOT.initialized) {
              window.__CMS_BOOT.initialized = true;
              try {
                CMS.init({ config: "/admin/config.yml" });
              } finally {
                window.__CMS_BOOT.initializing = false;
              }
            }
          } else {
            // Retry shortly until the bundle is available
            setTimeout(tryInit, 50);
          }
        })();
      }

      async function fetchGithubUser(token) {
        const r = await fetch("https://api.github.com/user", {
          headers: { Authorization: "token " + token }
        });
        if (!r.ok) throw new Error("GitHub /user failed: " + r.status);
        return r.json();
      }

      async function finishLoginAndInit(token) {
        try {
          const ghUser = await fetchGithubUser(token);
          console.log("[admin] GitHub user:", ghUser.login);

          // Enforce allowlist
          if (!ALLOWED_USERS.includes(ghUser.login)) {
            console.warn("[admin] user not allowed:", ghUser.login);
            try {
              localStorage.removeItem("decap-cms-user");
              localStorage.removeItem("netlify-cms-user");
            } catch (e) {}
            const msg = document.createElement("p");
            msg.style.cssText =
              "max-width:640px;margin:2rem auto;color:#b00020;text-align:center;font:600 16px/1.5 system-ui,sans-serif";
            msg.textContent =
              "Your GitHub account (" + ghUser.login + ") is not allowed to access this CMS.";
            document.body.appendChild(msg);
            return;
          }

          // Save session in Decap's expected shape
          const userPayload = { token, provider: "github", login: ghUser.login, user: ghUser };
          try {
            localStorage.setItem("decap-cms-user", JSON.stringify(userPayload));
            localStorage.setItem("netlify-cms-user", JSON.stringify(userPayload)); // legacy key
          } catch (e) {}

          console.log("[admin] saved Decap user", userPayload);

          // Init CMS exactly once
          scheduleInitOnce();
        } catch (err) {
          console.error("[admin] login finalize failed:", err);
          try {
            localStorage.removeItem("decap-cms-user");
            localStorage.removeItem("netlify-cms-user");
          } catch (e) {}
        }
      }

      // Bootstrap: if a user is already stored, finish directly; otherwise wait for OAuth message
      (function bootstrap() {
        try {
          const existing = localStorage.getItem("decap-cms-user");
          if (existing) {
            const saved = JSON.parse(existing);
            const token = saved?.token || null;
            if (token) {
              console.log("[admin] found existing session; finishing...");
              finishLoginAndInit(token);
              return;
            }
          }
        } catch (e) {}

        // Wait for the OAuth popup to send us the token
        window.addEventListener("message", function (e) {
          if (e.origin !== "https://ffl-oauth.vercel.app") return;
          if (typeof e.data === "string" && e.data.indexOf("authorization:github:success:") === 0) {
            const token = e.data.replace("authorization:github:success:", "").trim();
            console.log("[admin] oauth success; token received");
            finishLoginAndInit(token);
          }
        });
      })();
    </script>
  </head>
  <body>
    <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
  </body>
</html>
