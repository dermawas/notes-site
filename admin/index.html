<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>FlowformLab CMS</title>
    <meta name="robots" content="noindex" />
    <!-- IMPORTANT: we do NOT set window.CMS_MANUAL_INIT here.
         We let Decap auto-init AFTER we persist the token. -->

<script>
(function () {
  var OAUTH_ORIGIN = "https://ffl-oauth.vercel.app";
  var RELOAD_FLAG = "ffl_oauth_reload_once";
  var KEY = "decap-cms-user";

  function log(){try{console.log("[admin]",...arguments);}catch(e){}}
  function getUser(){try{return JSON.parse(localStorage.getItem(KEY)||"null");}catch(_){return null;}}

  async function saveUserToken(token) {
    if (!token) return;

    // Also fetch GitHub username â€” required for Decap login
    let ghUser = null;
    try {
      const res = await fetch("https://api.github.com/user", {
        headers: { Authorization: "token " + token },
      });
      ghUser = await res.json();
      log("GitHub user:", ghUser.login);
    } catch (e) {
      console.error("[admin] GH user fetch failed", e);
    }

    const value = {
      token: token,
      backendName: "github",
      login: ghUser?.login || null,  // important for Decap
      user: ghUser || null
    };

    localStorage.setItem(KEY, JSON.stringify(value));
    localStorage.setItem("netlify-cms-user", JSON.stringify(value));
    log("saved Decap user", value);
  }

  // accept OAuth postMessage
  window.addEventListener("message", async function (e) {
    if (e.origin !== OAUTH_ORIGIN || typeof e.data !== "string") return;

    if (e.data.startsWith("authorization:github:success:")) {
      const token = e.data.replace("authorization:github:success:", "").trim();
      await saveUserToken(token);
      sessionStorage.setItem(RELOAD_FLAG, "1");
      location.replace("/admin/?no_bundle_cache=1#/");
    }
  });

  if (sessionStorage.getItem(RELOAD_FLAG)) {
    sessionStorage.removeItem(RELOAD_FLAG);
    log("post-reload: auto-init Decap");
  }
})();
</script>

  </head>
  <body>
    <!-- Load Decap AFTER the shim so it can see the token on first paint -->
    <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
  </body>
</html>
