<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>FlowformLab CMS</title>
    <meta name="robots" content="noindex" />

    <script>
      (function () {
        // Your Vercel OAuth origin (must match the domain that serves /api/auth & /api/callback)
        var OAUTH_ORIGIN = "https://ffl-oauth.vercel.app";

        function saveUser(user) {
          try {
            var normalized = {
              token: user && user.token,
              provider: "github"
            };
            if (!normalized.token) return;
            localStorage.setItem("decap-cms-user", JSON.stringify(normalized));
            localStorage.setItem("netlify-cms-user", JSON.stringify(normalized));
          } catch (e) {
            console.error("[admin] failed to write cms-user:", e);
          }
        }

        // 1) Upgrade any existing user object (add provider, mirror legacy key)
        (function upgradeExisting() {
          try {
            var raw = localStorage.getItem("decap-cms-user");
            if (!raw) return;
            var obj = {};
            try { obj = JSON.parse(raw); } catch (_) {}
            if (obj && obj.token) {
              if (!obj.provider) {
                obj.provider = "github";
                console.log("[admin] added provider to existing decap-cms-user");
              }
              saveUser(obj);
            }
          } catch (e) {
            console.warn("[admin] upgradeExisting error:", e);
          }
        })();

        // 2) Listen for OAuth popup messages and persist token
        window.addEventListener("message", function (e) {
          if (e.origin !== OAUTH_ORIGIN) return;
          if (typeof e.data !== "string") return;

          if (e.data.indexOf("authorization:github:success:") === 0) {
            var token = e.data.replace("authorization:github:success:", "").trim();
            saveUser({ token: token });
            // Force reload so Decap immediately uses the stored user
            if (!/no_bundle_cache=1/.test(location.search)) {
              // small suffix to defeat bundle caching on first load after auth
              var url = location.pathname + "?no_bundle_cache=1" + location.hash;
              location.replace(url);
            } else {
              location.reload();
            }
          }

          if (e.data.indexOf("authorization:github:error:") === 0) {
            console.error("[admin] OAuth error:", e.data);
          }
        }, false);
      })();
    </script>
  </head>
  <body>
    <!-- Decap CMS -->
    <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
  </body>
</html>
