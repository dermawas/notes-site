<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>FlowformLab CMS</title>
    <meta name="robots" content="noindex" />

    <!-- Prevent auto boot; we will start CMS manually with our config -->
    <script>window.CMS_MANUAL_INIT = true;</script>

    <script>
      (function () {
        var OAUTH_ORIGIN = "https://ffl-oauth.vercel.app";

        function log(){ try{ console.log.apply(console, ["[admin]"].concat([].slice.call(arguments))); }catch(e){} }
        function err(){ try{ console.error.apply(console, ["[admin]"].concat([].slice.call(arguments))); }catch(e){} }

        function saveUser(user) {
          if (!user || !user.token) return;
          var normalized = { token: user.token, provider: "github" };
          try {
            localStorage.setItem("decap-cms-user", JSON.stringify(normalized));
            localStorage.setItem("netlify-cms-user", JSON.stringify(normalized)); // legacy mirror
            log("saved user with provider=github");
          } catch (e) { err("failed to write cms-user", e); }
        }

        // Normalize any existing user
        (function normalizeExisting() {
          try {
            var raw = localStorage.getItem("decap-cms-user");
            if (!raw) return;
            var obj = {}; try { obj = JSON.parse(raw); } catch(_) {}
            if (obj && obj.token) {
              if (!obj.provider) obj.provider = "github";
              saveUser(obj);
              log("normalized existing decap-cms-user");
            } else {
              localStorage.removeItem("decap-cms-user");
              localStorage.removeItem("netlify-cms-user");
            }
          } catch(e){ /* noop */ }
        })();

        // OAuth popup messages
        window.addEventListener("message", function (e) {
          if (e.origin !== OAUTH_ORIGIN || typeof e.data !== "string") return;

          if (e.data.indexOf("authorization:github:success:") === 0) {
            var token = e.data.replace("authorization:github:success:", "").trim();
            log("oauth success; token received");
            saveUser({ token: token });

            // Reload (cache-busted) so CMS picks it up
            var url = location.pathname + "?no_bundle_cache=1" + location.hash;
            location.replace(url);
          } else if (e.data.indexOf("authorization:github:error:") === 0) {
            err("oauth error", e.data);
          }
        }, false);

        // Start CMS with explicit config path
        function startCMS() {
          if (window.CMS && typeof CMS.init === "function") {
            try {
              log("calling CMS.init({ config: '/admin/config.yml' })");
              CMS.init({ config: "/admin/config.yml" });
            } catch (e) { err("CMS.init threw", e); }
          } else {
            setTimeout(startCMS, 60);
          }
        }
        window.addEventListener("load", function(){ log("window load â†’ try CMS.init"); startCMS(); });
      })();
    </script>
  </head>
  <body>
    <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
  </body>
</html>
