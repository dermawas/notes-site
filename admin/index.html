<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>FlowformLab CMS</title>
    <meta name="robots" content="noindex" />

    <!-- OAuth shim: catch token from OAuth proxy BEFORE Decap loads -->
    <script>
      (function () {
        // Be flexible about subdomains (vercel preview, main, etc.)
        var OAUTH_HOST = "ffl-oauth.vercel.app";

        function isFromProxy(origin) {
          try {
            var u = new URL(origin);
            return u.host === OAUTH_HOST;
          } catch (e) {
            return false;
          }
        }

        function persistToken(raw) {
          var payload = JSON.stringify({ token: raw }); // the exact shape that worked earlier
          try {
            localStorage.setItem("decap-cms-user", payload);
            localStorage.setItem("netlify-cms-user", payload); // legacy key, harmless
            console.log("[admin] token persisted to localStorage.");
          } catch (err) {
            console.error("[admin] failed to persist token:", err);
          }
        }

        function onMsg(e) {
          // TEMP: log everything so we can see it
          console.log("[admin] postMessage received:", e.origin, e.data);

          if (!isFromProxy(e.origin)) return;
          if (typeof e.data !== "string") return;

          if (e.data.indexOf("authorization:github:success:") === 0) {
            var token = e.data.replace("authorization:github:success:", "").trim();
            persistToken(token);

            // Give localStorage a tick to flush, then reload so Decap picks it up
            setTimeout(function () {
              location.replace(location.href.split("#")[0]); // avoid hash issues
            }, 50);
          }

          if (e.data.indexOf("authorization:github:error:") === 0) {
            var msg = e.data.replace("authorization:github:error:", "").trim();
            console.error("[admin] OAuth error from proxy:", msg);
            alert("OAuth error: " + msg);
          }
        }

        window.addEventListener("message", onMsg, false);

        // Optional: if a token already exists, we can log it for sanity
        try {
          var existing = localStorage.getItem("decap-cms-user");
          if (existing) console.log("[admin] existing decap-cms-user:", existing);
        } catch {}
      })();
    </script>
  </head>
  <body>
    <!-- Decap CMS (load AFTER shim so the token is ready) -->
    <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
  </body>
</html>
