<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>FlowformLab CMS</title>
    <meta name="robots" content="noindex" />

    <!-- We’ll initialize CMS ourselves -->
    <script>
      window.CMS_MANUAL_INIT = true;
    </script>

    <style>
      /* keep a stable mount so React doesn’t fight the DOM */
      #nc-root { min-height: 60vh; }
    </style>

    <script>
      (function () {
        const OAUTH_ORIGIN = "https://ffl-oauth.vercel.app";
        let started = false;

        /** Save the FULL Decap user object (the shape Decap expects) */
        function saveDecapUser({ token, githubUser }) {
          const decapUser = {
            backendName: "github",
            login: githubUser.login,     // <- required by Decap UI
            token,                       // <- PAT
            user: githubUser             // <- full GH /user payload
          };

          const payload = JSON.stringify(decapUser);
          try {
            localStorage.setItem("decap-cms-user", payload);
            localStorage.setItem("netlify-cms-user", payload); // legacy key
            console.log("[admin] saved Decap user:", decapUser);
          } catch (e) {
            console.warn("[admin] failed to save user:", e);
          }
        }

        function startCMS() {
          if (started) return;
          if (!window.CMS) {
            requestAnimationFrame(startCMS);
            return;
          }
          started = true;
          console.log("[admin] calling CMS.init({ config: '/admin/config.yml' })");
          window.CMS.init({ config: "/admin/config.yml" });
        }

        // Handle token from OAuth popup
        window.addEventListener("message", async (e) => {
          if (e.origin !== OAUTH_ORIGIN) return;
          const s = String(e.data || "");
          if (!s.startsWith("authorization:github:success:")) return;

          const token = s.replace("authorization:github:success:", "").trim();
          console.log("[admin] oauth success; token received");

          try {
            // Fetch GitHub user to obtain login & full profile
            const r = await fetch("https://api.github.com/user", {
              headers: {
                Authorization: "token " + token,
                Accept: "application/vnd.github.v3+json"
              }
            });
            if (!r.ok) throw new Error("GitHub /user " + r.status);
            const ghUser = await r.json();
            console.log("[admin] GitHub user:", ghUser.login);

            // Save full user for Decap
            saveDecapUser({ token, githubUser: ghUser });

            // Normalize & reload so Decap boots with stored user
            location.hash = "#/";
            location.reload();
          } catch (err) {
            console.error("[admin] failed to build user from token:", err);
            // Last-resort fallback (will likely still show login)
            try {
              localStorage.setItem(
                "decap-cms-user",
                JSON.stringify({ backendName: "github", token })
              );
            } catch {}
            location.reload();
          }
        });

        // Optional emergency clear: /admin/?clear=1
        if (location.search.includes("clear=1")) {
          localStorage.removeItem("decap-cms-user");
          localStorage.removeItem("netlify-cms-user");
          console.log("[admin] cleared stored user");
        }

        // Always start CMS so the login UI renders when there is no user yet
        window.addEventListener("load", () => {
          startCMS();
        });
      })();
    </script>
  </head>
  <body>
    <div id="nc-root"></div>
    <!-- Load Decap after we set CMS_MANUAL_INIT -->
    <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
  </body>
</html>
