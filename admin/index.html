<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>FlowformLab CMS</title>
    <meta name="robots" content="noindex" />

    <!-- We’ll initialize CMS ourselves -->
    <script>
      window.CMS_MANUAL_INIT = true;
    </script>

    <style>
      /* keep a stable mount so React doesn’t fight the DOM */
      #nc-root { min-height: 60vh; }
    </style>

    <script>
      (function () {
        const OAUTH_ORIGIN = "https://ffl-oauth.vercel.app";
        let started = false;

        function saveToken(token) {
          const payload = JSON.stringify({ token });
          try {
            localStorage.setItem("decap-cms-user", payload);
            localStorage.setItem("netlify-cms-user", payload); // legacy
            console.log("[admin] token saved");
          } catch (e) {
            console.warn("[admin] failed to save token:", e);
          }
        }

        function startCMS() {
          if (started) return;
          if (!window.CMS) {
            // decap-cms script not ready yet; try again on next frame
            requestAnimationFrame(startCMS);
            return;
          }
          started = true;
          console.log("[admin] calling CMS.init()");
          window.CMS.init({ config: "/admin/config.yml" });
        }

        // Receive token from OAuth popup
        window.addEventListener("message", (e) => {
          if (e.origin !== OAUTH_ORIGIN) return;
          const s = String(e.data || "");
          if (!s.startsWith("authorization:github:success:")) return;

          const token = s.replace("authorization:github:success:", "").trim();
          console.log("[admin] oauth success; token received");
          saveToken(token);

          // Normalize to collections route so Decap boots in a known state
          location.hash = "#/";
          // Reload once to let Decap pick the stored token cleanly
          location.reload();
        });

        // Optional emergency clear: /admin/?clear=1
        if (location.search.includes("clear=1")) {
          localStorage.removeItem("decap-cms-user");
          localStorage.removeItem("netlify-cms-user");
          console.log("[admin] cleared stored user");
        }

        // Always start CMS so the login UI renders when there is no user yet
        window.addEventListener("load", () => {
          startCMS();
        });
      })();
    </script>
  </head>
  <body>
    <div id="nc-root"></div>
    <!-- Load Decap after we set CMS_MANUAL_INIT -->
    <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
  </body>
</html>
