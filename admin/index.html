<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>FlowformLab CMS</title>
    <meta name="robots" content="noindex" />
    <!-- IMPORTANT: we do NOT set window.CMS_MANUAL_INIT here.
         We let Decap auto-init AFTER we persist the token. -->

<script>
(function () {
  var OAUTH_ORIGIN = "https://ffl-oauth.vercel.app";
  var STORAGE_KEY = "decap-cms-user";
  var CONFIG_PATH = "/admin/config.yml";

  function log(){ try{ console.log("[admin]", ...arguments); }catch(e){} }

  function getSaved() {
    try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "null"); }
    catch (_) { return null; }
  }

  async function saveUserToken(token) {
    if (!token) return;

    // Fetch GitHub identity (handy for UI / debugging, not strictly required)
    let ghUser = null;
    try {
      const res = await fetch("https://api.github.com/user", {
        headers: { Authorization: "token " + token }
      });
      ghUser = await res.json();
      log("GitHub user:", ghUser?.login);
    } catch (e) {
      console.error("[admin] GH user fetch failed", e);
    }

    // IMPORTANT: Decap expects `provider: "github"`
    const value = {
      token: token,
      provider: "github",
      login: ghUser?.login || null,
      user: ghUser || null
    };

    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(value));
      localStorage.setItem("netlify-cms-user", JSON.stringify(value)); // compatibility
      log("saved Decap user", value);
    } catch (e) {
      console.error("[admin] failed to persist token", e);
    }
  }

  function initCMSWhenReady() {
    // Manual init is enabled; call CMS.init when the library is ready.
    if (window.CMS && typeof window.CMS.init === "function") {
      log("calling CMS.init({ config: '" + CONFIG_PATH + "' })");
      window.CMS.init({ config: CONFIG_PATH });
    } else {
      // Retry shortly until decap-cms script is loaded
      setTimeout(initCMSWhenReady, 50);
    }
  }

  // Handle OAuth popup message
  window.addEventListener("message", async function (e) {
    if (e.origin !== OAUTH_ORIGIN || typeof e.data !== "string") return;

    if (e.data.startsWith("authorization:github:success:")) {
      const token = e.data.replace("authorization:github:success:", "").trim();
      await saveUserToken(token);
      initCMSWhenReady();
    }
  });

  // If a user is already saved (e.g., after refresh), initialize CMS directly
  window.addEventListener("load", function () {
    const u = getSaved();
    if (u && u.provider === "github" && u.token) {
      log("existing decap-cms-user found; initializing CMS");
      initCMSWhenReady();
    }
  });
})();
</script>
  </head>
  <body>
    <!-- Load Decap AFTER the shim so it can see the token on first paint -->
    <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
  </body>
</html>
